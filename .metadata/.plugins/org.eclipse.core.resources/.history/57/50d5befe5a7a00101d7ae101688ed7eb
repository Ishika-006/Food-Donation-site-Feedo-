package com.ishika.foodwaste.web.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import com.ishika.foodwaste.jpa.entity.DeliveryLocation;
import com.ishika.foodwaste.jpa.entityManager.DeliveryLocationManager;
import com.ishika.foodwaste.jpa.utils.LocationDto;

@Service
public class LocationSimulationService {

    @Autowired
    private DeliveryLocationManager deliveryLocationRepo;

    @Autowired
    private SimpMessagingTemplate messagingTemplate;

    // Simulate movement every 5 seconds
    @Scheduled(fixedRate = 5000)
    public void simulateMovement() {
        int deliveryPersonId = 1; // Replace with actual test delivery person ID

        DeliveryLocation loc = deliveryLocationRepo.findByDid(deliveryPersonId);
        if (loc == null) return;

        // Slightly change latitude and longitude to simulate movement
        loc.setLatitude(loc.getLatitude() + 0.0001);
        loc.setLongitude(loc.getLongitude() + 0.0001);

        deliveryLocationRepo.save(loc); // Update DB

        LocationDto dto = new LocationDto(loc.getLatitude(), loc.getLongitude());

        // Send to WebSocket subscribers
        messagingTemplate.convertAndSend("/topic/delivery/" + deliveryPersonId, dto);

        System.out.println("ðŸ“¡ Sent simulated location: " + dto.getLatitude() + ", " + dto.getLongitude());
    }
}

